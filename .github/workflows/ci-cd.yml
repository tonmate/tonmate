name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        default: "full-pipeline"
        type: choice
        options:
          - full-pipeline
          - deploy-only
          - migrations-only
      environment:
        description: "Environment to target"
        required: true
        default: "production"
        type: choice
        options:
          - production
      tag:
        description: "Image tag to deploy"
        required: false
        default: "latest"
        type: string

env:
  NODE_VERSION: "20.x"
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: write
  packages: write
  id-token: write
  security-events: write

jobs:
  test:
    name: Run Tests
    if: github.event.inputs.action != 'deploy-only' && github.event.inputs.action != 'migrations-only'
    uses: ./.github/workflows/test.yml
    with:
      node-version: ${{ env.NODE_VERSION }}
    secrets:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  build:
    name: Build and Push Image
    needs: [test]
    if: |
      success() &&
      github.event.inputs.action != 'deploy-only' && 
      github.event.inputs.action != 'migrations-only' && 
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    uses: ./.github/workflows/build.yml
    with:
      node-version: ${{ env.NODE_VERSION }}
      registry: ${{ env.REGISTRY }}
      image-name: ${{ env.IMAGE_NAME }}
      dockerfile-path: docker/Dockerfile
    secrets:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

  deploy:
    name: Deploy Application
    needs: [build]
    if: |
      (github.ref == 'refs/heads/main' && needs.build.result == 'success') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'deploy-only')
    uses: ./.github/workflows/deploy.yml
    with:
      environment: ${{ github.event.inputs.environment || 'production' }}
      tag: ${{ github.event.inputs.tag || needs.build.outputs.new_release_version || 'latest' }}
      registry: ${{ env.REGISTRY }}
      image-name: ${{ env.IMAGE_NAME }}
      deployments-repo: "tonmate/deployments"
    secrets:
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      SSH_USER: ${{ secrets.SSH_USER }}
      VPS_HOST: ${{ secrets.VPS_HOST }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

  migrations:
    name: Run Database Migrations
    if: github.event.inputs.action == 'migrations-only'
    uses: ./.github/workflows/migrations.yml
    with:
      node-version: ${{ env.NODE_VERSION }}
      environment: ${{ github.event.inputs.environment || 'production' }}
      tag: ${{ github.event.inputs.tag || 'latest' }}
      registry: ${{ env.REGISTRY }}
      image-name: ${{ env.IMAGE_NAME }}
      deployments-repo: "tonmate/deployments"
    secrets:
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      SSH_USER: ${{ secrets.SSH_USER }}
      VPS_HOST: ${{ secrets.VPS_HOST }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
